name: Release Build - android12-5.10

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Pilih Varian Kernel yang akan dibangun'
        required: true
        default: 'KSU'
        type: choice
        options:
          - 'VNL (Vanilla - No Root)'
          - 'KSU (KernelSU Next + All Manager)'
          - 'KSU SuSFS (KernelSU Next + SuSFS)'
          - 'ReSukiSU (KernelSU All Manager + SuSFS)'

jobs:
  build:
    # Nama job akan mengikuti varian yang dipilih
    name: Build ${{ github.event.inputs.variant }}
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      # Logika Mapping Pilihan ke Variabel Build Script
      # Jika VNL -> KSU=no
      # Jika ReSukiSU -> KSU=resukisu
      # Selain itu (KSU / KSU SuSFS) -> KSU=yes
      KSU: ${{ github.event.inputs.variant == 'VNL (Vanilla - No Root)' && 'no' || (github.event.inputs.variant == 'ReSukiSU (KernelSU All Manager + SuSFS)' && 'resukisu' || 'yes') }}
      
      # Logika Mapping SuSFS
      # Hanya aktif jika pilihan mengandung kata 'SuSFS'
      KSU_SUSFS: ${{ contains(github.event.inputs.variant, 'SuSFS') && 'true' || 'false' }}
      
      # Karena build dipilih manual, ini adalah build terakhir (LAST_BUILD=true)
      LAST_BUILD: "true"
      KSU_MANUAL_HOOK: "false"
      TODO: "kernel"
      KERNEL_VERSION: "5.10"

  release:
    name: Create Unified Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Extract variables from info.txt (Safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Find info.txt file
          info_file=$(find release_files -name "info.txt" -type f | head -1)

          if [[ -f "$info_file" ]]; then
            echo "Found info.txt at: $info_file"

            # Extract variables safely without using functions.sh
            while IFS='=' read -r key value; do
              # Skip empty lines and comments
              [[ -z "$key" || "$key" =~ ^#.*$ ]] && continue

              # Clean up whitespace
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)

              # Validate that we have both key and value
              if [[ -n "$key" && -n "$value" ]]; then
                echo "Setting: $key=$value"
                echo "$key=$value" >> $GITHUB_ENV
              fi
            done < "$info_file"

            echo "Variables extracted successfully"
          fi

      - name: Generate release tag
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
            # LOGIC UPDATE: Gunakan versi dari build.sh jika tersedia, jika tidak gunakan logika increment r1, r2 (fallback)
            if [[ -n "$RELEASE" ]]; then
                # Jika variabel RELEASE ada (dari info.txt), buat tag berdasarkan itu (contoh: VorteX-v0.3)
                PROPOSED_TAG="${KERNEL_NAME}-${RELEASE}"

                # Cek apakah tag ini sudah ada di remote untuk menghindari error
                if gh release view "$PROPOSED_TAG" --repo "$RELEASE_REPO" > /dev/null 2>&1; then
                    echo "Tag $PROPOSED_TAG already exists. Appending timestamp to avoid conflict."
                    RELEASE_TAG="${PROPOSED_TAG}-$(date +%Y%m%d)"
                else
                    RELEASE_TAG="$PROPOSED_TAG"
                fi
            else
                # Fallback ke logika asli jika RELEASE tidak ditemukan (membuat r1, r2, dst)
                LATEST_TAG=$(gh api repos/$RELEASE_REPO/tags --jq '.[0].name' 2>/dev/null || echo "")

                if [[ -z "$LATEST_TAG" ]] || ! echo "$LATEST_TAG" | grep -q "$KERNEL_NAME"; then
                    RELEASE_TAG="$KERNEL_NAME-r1"
                else
                    RELEASE_TAG="$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')"
                fi
            fi

            echo "Release tag: $RELEASE_TAG"
            echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Upload All Builds to release repo
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.RELEASE_REPO }}
          name: ${{ env.RELEASE_TAG }}
          tag_name: ${{ env.RELEASE_TAG }}
          prerelease: true
          files: release_files/**/*
          body: |
            ### ðŸ“¢ ${{ env.RELEASE_TAG }} Builds
            -> Linux ${{ env.LINUX_VERSION }} (android12-5.10-lts)
            -> SUSFS à¶ž ${{ env.SUSFS_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Send notification to TG (Safe)
        run: |
            MESSAGE="ðŸ“¦ Release completed! [Click](https://github.com/${{ env.RELEASE_REPO }}/releases/tag/${{ env.RELEASE_TAG }})"
            source functions.sh
            send_msg "$MESSAGE"
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
