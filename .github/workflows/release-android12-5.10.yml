name: Release Build - android12-5.10

on:
  workflow_dispatch:
    inputs:
      variant:
        description: 'Select Kernel Variant'
        required: true
        default: 'KSU'
        type: choice
        options:
          - 'VNL'
          - 'KSU'
          - 'KSU SuSFS'
          - 'ReSukiSU'

jobs:
  build:
    name: Build ${{ github.event.inputs.variant }}
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      KSU: ${{ github.event.inputs.variant == 'ReSukiSU' && 'resukisu' || (github.event.inputs.variant == 'VNL' && 'no' || 'yes') }}
      KSU_SUSFS: ${{ (github.event.inputs.variant == 'KSU SuSFS' || github.event.inputs.variant == 'ReSukiSU') && 'true' || 'false' }}
      LAST_BUILD: "true"
      KSU_MANUAL_HOOK: "false"
      TODO: "kernel"
      KERNEL_VERSION: "5.10"
      STATUS: "Stable"

  release:
    name: Create Unified Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_files

      - name: Extract variables from info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          info_file=$(find release_files -name "info.txt" -type f | head -1)

          if [[ -f "$info_file" ]]; then
            echo "Found info.txt at: $info_file"

            while IFS='=' read -r key value; do
              [[ -z "$key" || "$key" =~ ^#.*$ ]] && continue
              key=$(echo "$key" | xargs)
              value=$(echo "$value" | xargs)

              if [[ -n "$key" && -n "$value" ]]; then
                echo "$key=$value" >> $GITHUB_ENV
              fi
            done < "$info_file"
          fi

      - name: Generate release tag
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
            if [[ -n "$RELEASE" ]]; then
                PROPOSED_TAG="${KERNEL_NAME}-${RELEASE}"

                if gh release view "$PROPOSED_TAG" --repo "$RELEASE_REPO" > /dev/null 2>&1; then
                    echo "Tag $PROPOSED_TAG already exists. Appending timestamp."
                    RELEASE_TAG="${PROPOSED_TAG}-$(date +%Y%m%d)"
                else
                    RELEASE_TAG="$PROPOSED_TAG"
                fi
            else
                LATEST_TAG=$(gh api repos/$RELEASE_REPO/tags --jq '.[0].name' 2>/dev/null || echo "")

                if [[ -z "$LATEST_TAG" ]] || ! echo "$LATEST_TAG" | grep -q "$KERNEL_NAME"; then
                    RELEASE_TAG="$KERNEL_NAME-r1"
                else
                    RELEASE_TAG="$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')"
                fi
            fi

            echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Upload All Builds to release repo
        uses: softprops/action-gh-release@v2
        with:
          repository: ${{ env.RELEASE_REPO }}
          name: ${{ env.RELEASE_TAG }}
          tag_name: ${{ env.RELEASE_TAG }}
          prerelease: true
          files: release_files/**/*
          body: |
            ### ðŸ“¢ ${{ env.RELEASE_TAG }} Builds
            -> Linux ${{ env.LINUX_VERSION }} (android12-5.10-lts)
            -> SUSFS à¶ž ${{ env.SUSFS_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Send notification to TG
        run: |
            MESSAGE="ðŸ“¦ Release completed! [Click](https://github.com/${{ env.RELEASE_REPO }}/releases/tag/${{ env.RELEASE_TAG }})"
            source functions.sh
            send_msg "$MESSAGE"
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
